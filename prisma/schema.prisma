// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// SIMPLIFIED ENUMS - Taiwan only, no i18n needed
// =============================================

enum MemberRole {
  admin
  staff
}

enum ServiceUnit {
  year
  month
  time
  piece
}

enum OrderStatus {
  pending
  completed
  cancelled
}

// Standardized prayer service codes
enum PrayerServiceCode {
  TAISUI      // ÂÆâÂ§™Ê≠≤
  GUANGMING   // ÂÖâÊòéÁáà
  WENCHANG    // ÊñáÊòåÁáà
  BAIDOU      // ÊãúÊñó
  YUELAO      // ÊúàËÄÅÂßªÁ∑£Á∞ø
}

// =============================================
// MAIN TABLES
// =============================================

/// Temple tenant definition
model temples {
  id                      String    @id @default(uuid()) @db.Uuid

  // Basic Info
  name                    String
  slug                    String    @unique
  intro                   String?   @db.Text
  full_description        String?   @db.Text

  // Contact & Location
  address                 String?
  phone                   String?
  email                   String?
  hours                   String?   @default("ÊØèÊó• 06:00 - 21:00")

  // Images & Media
  cover_image_url         String?
  avatar_emoji            String?   @default("üèõÔ∏è")
  logo_url                String?   // R2 storage URL for temple logo
  favicon_url             String?   // R2 storage URL for favicon
  gallery_photos          String[]  @default([]) // Array of R2 URLs for gallery (max 6)

  // Social Links
  facebook_url            String?   @db.Text
  line_id                 String?
  instagram_url           String?   @db.Text

  // System
  is_active               Boolean   @default(true)
  created_by_auth_user_id String    // Clerk auth user id
  created_at              DateTime  @default(now()) @db.Timestamptz(6)
  updated_at              DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  members                 temple_members[]
  services                services[]
  events                  events[]
  orders                  orders[]
  gallery                 gallery_images[]
  stats                   temple_stats[]
  prayer_services         temple_prayer_services[]
  donation_settings       temple_donation_settings?
}

/// Temple membership
model temple_members {
  id           String      @id @default(uuid()) @db.Uuid
  temple_id    String      @db.Uuid
  auth_user_id String      // Clerk auth user id
  role         MemberRole
  joined_at    DateTime    @default(now()) @db.Timestamptz(6)
  created_at   DateTime    @default(now()) @db.Timestamptz(6)

  temple temples @relation(fields: [temple_id], references: [id], onDelete: Cascade)

  @@unique([temple_id, auth_user_id])
}

/// Services offered by temple (ÂÖâÊòéÁáà, Â§™Ê≠≤Ááà, etc)
model services {
  id          String      @id @default(uuid()) @db.Uuid
  temple_id   String      @db.Uuid
  icon        String      @default("ü™î")  // emoji icon
  name        String
  description String?     @db.Text
  price       Int         // Price in TWD
  unit        ServiceUnit @default(year)
  is_popular  Boolean     @default(false)
  is_active   Boolean     @default(true)
  sort_order  Int         @default(0)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime    @updatedAt @db.Timestamptz(6)

  temple      temples     @relation(fields: [temple_id], references: [id], onDelete: Cascade)
  orders      orders[]
}

/// Events and activities (Ê≥ïÊúÉ, ÊÖ∂ÂÖ∏, etc)
model events {
  id                    String    @id @default(uuid()) @db.Uuid
  temple_id             String    @db.Uuid
  title                 String
  description           String?   @db.Text
  image_url             String?
  event_date            DateTime  @db.Date
  event_time            String    // "09:00"
  location              String
  max_capacity          Int?
  current_registrations Int       @default(0)
  registration_deadline DateTime? @db.Timestamptz(6)
  is_active             Boolean   @default(true)
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  updated_at            DateTime  @updatedAt @db.Timestamptz(6)

  temple                temples   @relation(fields: [temple_id], references: [id], onDelete: Cascade)
  orders                orders[]
}

/// Orders for services, donations, events
model orders {
  id              String       @id @default(uuid()) @db.Uuid
  temple_id       String       @db.Uuid
  order_number    String       @unique // ORD000001
  order_type      String       @default("service") // service/donation/event
  service_id      String?      @db.Uuid
  event_id        String?      @db.Uuid

  // Customer info
  customer_name   String
  customer_email  String?
  customer_phone  String?

  // Payment info
  amount          Int          // Amount in TWD
  status          OrderStatus  @default(pending)
  payment_method  String?
  payment_status  String?      @default("pending")

  notes           String?      @db.Text
  created_at      DateTime     @default(now()) @db.Timestamptz(6)
  updated_at      DateTime     @updatedAt @db.Timestamptz(6)
  completed_at    DateTime?    @db.Timestamptz(6)

  temple          temples      @relation(fields: [temple_id], references: [id], onDelete: Cascade)
  service         services?    @relation(fields: [service_id], references: [id], onDelete: SetNull)
  event           events?      @relation(fields: [event_id], references: [id], onDelete: SetNull)
}

/// Gallery images for temple
model gallery_images {
  id          String    @id @default(uuid()) @db.Uuid
  temple_id   String    @db.Uuid
  image_url   String
  caption     String?
  sort_order  Int       @default(0)
  is_featured Boolean   @default(false)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)

  temple      temples   @relation(fields: [temple_id], references: [id], onDelete: Cascade)
}

/// Daily statistics for analytics and export
model temple_stats {
  id               String    @id @default(uuid()) @db.Uuid
  temple_id        String    @db.Uuid
  date             DateTime  @db.Date
  views            Int       @default(0)
  unique_visitors  Int       @default(0)
  donations_amount Int       @default(0)
  orders_count     Int       @default(0)
  created_at       DateTime  @default(now()) @db.Timestamptz(6)

  temple           temples   @relation(fields: [temple_id], references: [id], onDelete: Cascade)

  @@unique([temple_id, date])
}

/// Temple prayer services configuration
/// Each temple can enable/disable standardized prayer services
model temple_prayer_services {
  id               String            @id @default(uuid()) @db.Uuid
  temple_id        String            @db.Uuid
  service_code     PrayerServiceCode // Standardized service code
  is_enabled       Boolean           @default(false)
  custom_price     Int?              // Override default price if needed
  max_quantity     Int?              // Limit per order if needed
  annual_limit     Int?              // Annual capacity limit
  current_year     Int?              // Current year for tracking
  current_count    Int               @default(0) // Current registrations this year
  created_at       DateTime          @default(now()) @db.Timestamptz(6)
  updated_at       DateTime          @updatedAt @db.Timestamptz(6)

  temple           temples           @relation(fields: [temple_id], references: [id], onDelete: Cascade)

  @@unique([temple_id, service_code])
  @@index([temple_id, is_enabled])
}

/// Temple donation settings
model temple_donation_settings {
  id                    String    @id @default(uuid()) @db.Uuid
  temple_id             String    @unique @db.Uuid
  is_enabled            Boolean   @default(true)
  min_amount            Int       @default(100) // Minimum donation amount
  suggested_amounts     Int[]     @default([100, 300, 500, 1000, 3000, 5000])
  allow_anonymous       Boolean   @default(true)
  custom_message        String?   @db.Text // Custom thank you message
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  updated_at            DateTime  @updatedAt @db.Timestamptz(6)

  temple                temples   @relation(fields: [temple_id], references: [id], onDelete: Cascade)
}

/// Prayer service orders (extends the existing orders table)
model prayer_service_orders {
  id                    String              @id @default(uuid()) @db.Uuid
  order_id              String              @db.Uuid // Links to main orders table
  service_code          PrayerServiceCode
  quantity              Int                 @default(1)
  unit_price            Int
  subtotal              Int
  blessing_entries      Json                // Store blessing entry details as JSON
  created_at            DateTime            @default(now()) @db.Timestamptz(6)

  @@index([order_id])
}